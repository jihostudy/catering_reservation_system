name: Create Release

on:
  push:
    tags:
      - "v*" # v1.0.0, v1.1.0 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ë¦´ë¦¬ì¦ˆ ìƒì„±ì— í•„ìš”í•œ ê¶Œí•œ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: extension/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ./extension
        run: pnpm install --no-frozen-lockfile

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in package.json and manifest.json
        working-directory: ./extension
        run: |
          VERSION="${{ steps.tag_version.outputs.VERSION }}"
          # package.json ë²„ì „ ì—…ë°ì´íŠ¸
          npm pkg set version="$VERSION"
          # manifest.json ë²„ì „ ì—…ë°ì´íŠ¸
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '$VERSION';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2) + '\n');
          "

      - name: Clean build files
        working-directory: ./extension
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì‚­ì œ ì¤‘..."
          rm -rf dist
          echo "âœ… ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ ì‚­ì œ ì™„ë£Œ"

      - name: Build extension
        working-directory: ./extension
        run: |
          echo "ğŸ”¨ Extension ë¹Œë“œ ì¤‘..."
          pnpm build
          echo "âœ… Extension ë¹Œë“œ ì™„ë£Œ"
          echo "ğŸ“¦ ë¹Œë“œëœ íŒŒì¼:"
          ls -lh dist/

      - name: Create ZIP package
        working-directory: ./extension
        run: |
          chmod +x create-zip.sh
          ./create-zip.sh

      - name: Generate release notes
        id: release_notes
        run: |
          TAG="${{ github.ref_name }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            NOTES="## ë³€ê²½ì‚¬í•­\n\nì´ë²ˆ ë¦´ë¦¬ì¦ˆì˜ ì£¼ìš” ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”."
          else
            NOTES="## ë³€ê²½ì‚¬í•­\n\n\`\`\`\n$(git log ${PREV_TAG}..HEAD --pretty=format:'- %s' --no-merges)\n\`\`\`"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: extension/catering-extension-v${{ steps.tag_version.outputs.VERSION }}.zip
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ ë¦´ë¦¬ì¦ˆ ${{ github.ref_name }}

            ${{ steps.release_notes.outputs.notes }}

            ## ğŸ“¦ ì„¤ì¹˜ ë°©ë²•

            1. ìœ„ì˜ **catering-extension-v${{ steps.tag_version.outputs.VERSION }}.zip** íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
            2. ZIP íŒŒì¼ì„ ì••ì¶• í•´ì œí•˜ì„¸ìš”.
            3. Chrome ë¸Œë¼ìš°ì €ì—ì„œ `chrome://extensions/` ì ‘ì†
            4. ìš°ì¸¡ ìƒë‹¨ **"ê°œë°œì ëª¨ë“œ"** í™œì„±í™”
            5. **"ì••ì¶•í•´ì œëœ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•©ë‹ˆë‹¤"** í´ë¦­
            6. ì••ì¶• í•´ì œí•œ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.

            > ğŸ’¡ ìì„¸í•œ ì‚¬ìš© ë°©ë²•ì€ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
